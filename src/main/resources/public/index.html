<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Binance Top 涨幅 & 振幅 + 强势币通知</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 10px; background: #f9f9f9; }
        h1 { text-align: center; }
        #controls { text-align: center; margin-bottom: 10px; }
        #tables { display: flex; flex-direction: column; gap: 10px; }
        #change-tables, #amplitude-tables { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        .table-container { background: #fff; padding: 8px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); width: 440px; }
        table { border-collapse: collapse; width: 100%; font-size:10px; }
        th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }
        th { background: #eee; }
        h2 { text-align: center; margin-top: 0; font-size: 14px; }
        #strong-notice { padding: 6px; text-align:center; background:#ffeeba; font-weight:bold; user-select:text; cursor:default; }
        .strong-coin { margin:0 4px; color:#d63384; font-weight:bold; }
    </style>
</head>
<body>

<div id="controls">
    当前时间：<span id="currentTime">--</span>
    &nbsp;&nbsp;&nbsp;
    刷新时间：<span id="lastUpdateTime">--</span>
    <label>刷新间隔（秒）：<input type="number" id="refreshInterval" value="60" min="5" max="600" style="width:50px;"></label>
    <button onclick="restartAutoRefresh()">应用</button>
    <button onclick="startTimer()">开始</button>
    <button onclick="stopTimer()">停止</button>
    &nbsp;&nbsp;状态：<span id="refreshStatus">正在刷新</span>
    显示周期：
    <span id="intervalButtons"></span>
</div>

<!-- 强势币通知条 -->
<div id="strong-notice"></div>

<div id="tables">
    <div id="change-tables"></div>
    <div id="amplitude-tables"></div>
</div>

<audio id="alertSound">
    <source src="/alert.wav" type="audio/wav">
</audio>
<audio id="alertSoundStrong">
    <source src="/strong.wav" type="audio/wav">
</audio>
<script>
    let refreshSeconds = 0.5;
    let timer = null;
    const TOP_NUM = 10;
    const threshold = 4;
    let errNum = 0;//报错次数统计

    let lastRankJson = "";
    let lastStrongJson = "";

    const INTERVALS = ["5m","10m","15m","30m","40m","50m","60m"];
    const defaultSelected = ["5m","15m","30m"];
    let selectedIntervals = JSON.parse(localStorage.getItem("selectedIntervals") || "[]");
    if(selectedIntervals.length === 0) selectedIntervals = defaultSelected;

    const intervalContainer = document.getElementById("intervalButtons");
    INTERVALS.forEach(i=>{
        const btn = document.createElement("button");
        btn.innerText = i;
        btn.style.margin = "2px";
        btn.style.padding = "2px 6px";
        btn.style.fontSize = "12px";
        btn.style.border = "1px solid #ccc";
        btn.style.borderRadius = "4px";
        btn.style.background = selectedIntervals.includes(i) ? "#0d6efd" : "#fff";
        btn.style.color = selectedIntervals.includes(i) ? "#fff" : "#000";
        btn.onclick = () => {
            if(selectedIntervals.includes(i)){
                selectedIntervals = selectedIntervals.filter(x=>x!==i);
                btn.style.background="#fff"; btn.style.color="#000";
            } else {
                selectedIntervals.push(i);
                btn.style.background="#0d6efd"; btn.style.color="#fff";
            }
            localStorage.setItem("selectedIntervals", JSON.stringify(selectedIntervals));
            fetchRankData(true);
        };
        intervalContainer.appendChild(btn);
    });

    // ----------- 涨幅榜刷新 -----------
    async function fetchRankData(forceUpdate=false) {
        try {
            const res = await fetch('/data', { cache: "no-store" });
            const data = await res.json();

            const currentJson = JSON.stringify(data);
            if(!forceUpdate && currentJson === lastRankJson) return; // 只有非强制刷新才判断
            updateLastChangeTime();
            lastRankJson = currentJson;
            console.log("涨幅榜数据更新：",currentJson)
            let changeHtml = '';
            errNum=0;

            // 按后端 INTERVALS 顺序循环
            INTERVALS.forEach(interval => {
                if (!selectedIntervals.includes(interval)) return; // 未选中，跳过
                if (!data[interval]) return;

                const changeList = data[interval].change.slice(0, TOP_NUM);
                changeHtml += `<div class="table-container">
                <h2>${interval} K 线 Top ${TOP_NUM} 涨幅</h2>
                <table>
                    <tr>
                        <th>排名</th><th>交易对</th>
                        <th>5分涨幅(%)</th><th>5分振幅(%)</th>
                        <th>15分涨幅(%)</th><th>15分振幅(%)</th>
                        <th>30分涨幅(%)</th><th>30分振幅(%)</th>
                        <th>60分涨幅(%)</th><th>60分振幅(%)</th>
                        <th>收盘</th>
                    </tr>`;
                changeList.forEach((c,i)=>{
                    changeHtml += `<tr>
                    <td>${i+1}</td>
                    <td>${c.symbol}</td>
                    <td>${c.others && c.others['5m']?c.others['5m'].change.toFixed(2):'-'}</td>
                    <td>${c.others && c.others['5m']?c.others['5m'].amplitude.toFixed(2):'-'}</td>
                    <td>${c.others && c.others['15m']?c.others['15m'].change.toFixed(2):'-'}</td>
                    <td>${c.others && c.others['15m']?c.others['15m'].amplitude.toFixed(2):'-'}</td>
                    <td>${c.others && c.others['30m']?c.others['30m'].change.toFixed(2):'-'}</td>
                    <td>${c.others && c.others['30m']?c.others['30m'].amplitude.toFixed(2):'-'}</td>
                    <td>${c.others && c.others['60m']?c.others['60m'].change.toFixed(2):'-'}</td>
                    <td>${c.others && c.others['60m']?c.others['60m'].amplitude.toFixed(2):'-'}</td>
                    <td>${c.close.toFixed(5)}</td>
                </tr>`;
                });
                changeHtml += `</table></div>`;
            });

            document.getElementById('change-tables').innerHTML = changeHtml;

            // 涨幅提醒
            if (data["5m"]) {
                const list5m = data["5m"].change;
                const maxChange = Math.max(...list5m.map(c=>Number(c.change)));
                if(maxChange >= threshold){
                    const audio = document.getElementById("alertSound");
                    audio.volume = 0.3;
                    audio.currentTime = 0;
                    audio.play().catch(()=>{});
                    console.log("涨幅超过阈值，已提醒一次！");
                }
            }

        } catch(err){
            errNum++;
            if(errNum>=10){
                alert("数据刷新失败，请检查网络连接或联系管理员！");
                errNum=0;
            }
            console.error("数据刷新错误：", err);
        }
    }

    // ----------- 强势币通知条刷新 -----------
    async function fetchStrongData() {
        try{
            const res = await fetch('/strong', { cache: "no-store" });
            const data = await res.json();

            const currentJson = JSON.stringify(data);
            if(currentJson === lastStrongJson) return;
            lastStrongJson = currentJson;
            console.log("强势币数据更新：",currentJson)
            const container = document.getElementById('strong-notice');
            container.innerHTML = data.map(c => `<span class="strong-coin">${c.symbol}</span>`).join(' ');

            if(data.length > 0){
                const audio = document.getElementById("alertSoundStrong");
                audio.volume = 0.5;
                audio.currentTime = 0;
                audio.play().catch(()=>{});
                console.log("发现新的强势币，已播放提醒音");
            }

        } catch(err){ console.error("强势币刷新错误：", err); }
    }

    // ----------- 定时刷新 -----------
    function startTimer(){
        if(timer) clearInterval(timer);
        timer = setInterval(()=>{
            fetchRankData();
            fetchStrongData();
        }, refreshSeconds*1000);
        document.getElementById('refreshStatus').innerText = "正在刷新";
        document.getElementById('refreshStatus').style.color = "green";
        console.log("自动刷新已启动，间隔:", refreshSeconds,"秒");
        fetchRankData();
        fetchStrongData();
    }

    function stopTimer(){
        if(timer){
            clearInterval(timer);
            timer=null;
            document.getElementById('refreshStatus').innerText = "已停止刷新";
            document.getElementById('refreshStatus').style.color = "red";
            console.log("自动刷新已停止");
        }
    }

    function restartAutoRefresh(){
        const v = parseInt(document.getElementById('refreshInterval').value);
        if(!isNaN(v) && v>=5 && v<=600) refreshSeconds = v;
        startTimer();
    }
    // 数据发生变化 → 记录更新时间
    function updateLastChangeTime() {
        const now = new Date();
        const pad = n => (n < 10 ? "0" + n : n);
        const str =
            now.getFullYear() + "-" +
            pad(now.getMonth() + 1) + "-" +
            pad(now.getDate()) + " " +
            pad(now.getHours()) + ":" +
            pad(now.getMinutes()) + ":" +
            pad(now.getSeconds());

        document.getElementById("lastUpdateTime").innerText = str;
    }

    function updateCurrentTime() {
        const now = new Date();
        const pad = n => (n < 10 ? "0" + n : n);
        const str =
            now.getFullYear() + "-" +
            pad(now.getMonth() + 1) + "-" +
            pad(now.getDate()) + " " +
            pad(now.getHours()) + ":" +
            pad(now.getMinutes()) + ":" +
            pad(now.getSeconds());

        document.getElementById("currentTime").innerText = str;
    }

    setInterval(updateCurrentTime, 1000);
    updateCurrentTime();
    startTimer();
</script>
</body>
</html>

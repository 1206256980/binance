<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Binance Top æ¶¨å¹… & æŒ¯å¹… + å¼ºåŠ¿å¸é€šçŸ¥</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 10px; background: #f9f9f9; }
        h1 { text-align: center; }
        #controls { text-align: center; margin-bottom: 10px;font-size: 12px; }
        #tables { display: flex; flex-direction: column; gap: 10px; }
        #change-tables, #amplitude-tables { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        .table-container { background: #fff; padding: 8px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); width: 440px; }
        table { border-collapse: collapse; width: 100%; font-size:10px; }
        th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }
        th { background: #eee; }
        h2 { text-align: center; margin-top: 0; font-size: 14px; }
        #strong-notice { padding: 6px; text-align:center; background:#ffeeba; font-weight:bold; user-select:text; cursor:default; }
        .strong-coin { margin:0 4px; color:#d63384; font-weight:bold; }
    </style>
</head>
<body>

<div id="controls">
    å½“å‰æ—¶é—´ï¼š<span id="currentTime">--</span>
    &nbsp;&nbsp;&nbsp;
    åˆ·æ–°æ—¶é—´ï¼š<span id="lastUpdateTime">--</span>
    <label>åˆ·æ–°é—´éš”ï¼ˆç§’ï¼‰ï¼š<input type="number" id="refreshInterval" value="60" min="5" max="600" style="width:50px;"></label>
    <button onclick="restartAutoRefresh()">åº”ç”¨</button>
    <button onclick="startTimer()">å¼€å§‹</button>
    <button onclick="stopTimer()">åœæ­¢</button>
    &nbsp;&nbsp;çŠ¶æ€ï¼š<span id="refreshStatus">æ­£åœ¨åˆ·æ–°</span>
    æ˜¾ç¤ºå‘¨æœŸï¼š
    <span id="intervalButtons"></span>
</div>

<!-- å¼ºåŠ¿å¸é€šçŸ¥æ¡ -->
<div id="strong-notice"></div>

<div id="tables">
    <div id="change-tables"></div>
    <div id="amplitude-tables"></div>
</div>

<audio id="alertSound">
    <source src="/alert.wav" type="audio/wav">
</audio>
<audio id="alertSoundStrong">
    <source src="/strong.wav" type="audio/wav">
</audio>
<audio id="alertError">
    <source src="/error.wav" type="audio/wav">
</audio>
<script>
    let refreshSeconds = 1.5;
    let timer = null;
    const TOP_NUM = 10;
    const threshold = 4;
    let errNum = 0;//æŠ¥é”™æ¬¡æ•°ç»Ÿè®¡

    let lastRankJson = "";
    let lastStrongJson = "";

    const INTERVALS = ["5m","10m","15m","30m","40m","50m","60m","120m","240m"];
    const defaultSelected = ["5m","15m","30m"];

    // ------------------- å¸ç§é¢œè‰²æ˜ å°„é…ç½® (å·²æ‰©å±•è‡³ 18 ç§æŸ”å’Œè‰²) -------------------
    const COLOR_POOL = [
        "#E3F2FD", // Light Blue
        "#E8F5E9", // Light Green
        "#FFF3E0", // Light Orange/Peach
        "#F3E5F5", // Light Purple
        "#FCE4EC", // Light Pink
        "#F0F4C3", // Light Olive
        "#F5F5F5", // Light Gray
        "#F5F5FF", // Very Light Lavender
        "#E0F7FA", // Very Light Cyan
        "#F9FBE7", // Very Light Yellow/Lime
        "#E1F5FE", // Another Light Blue
        "#FFFDE7", // Creamy Yellow
        "#FFEBEE", // Lighter Pink
        "#F0F8FF", // AliceBlue
        "#D1F2EB", // Light Mint
        "#FADBD8", // Light Rose
        "#EBF5FB", // Light Steel Blue
        "#D5F5E3"  // Light Emerald
    ];
    const COLOR_CACHE = {}; // ç¼“å­˜å·²åˆ†é…çš„å¸ç§é¢œè‰²

    // æ ¹æ®å¸ç§åç§°ç”Ÿæˆä¸€ä¸ªç¨³å®šçš„ã€å”¯ä¸€çš„èƒŒæ™¯è‰²
    function getSymbolBackgroundColor(symbol) {
        if (COLOR_CACHE[symbol]) {
            return COLOR_CACHE[symbol];
        }

        // ç®€å•çš„å­—ç¬¦ä¸²å“ˆå¸Œç®—æ³•
        let hash = 0;
        for (let i = 0; i < symbol.length; i++) {
            // ä½¿ç”¨ä½è¿ç®—ç”Ÿæˆå“ˆå¸Œå€¼
            hash = symbol.charCodeAt(i) + ((hash << 5) - hash);
        }

        // å°†å“ˆå¸Œå€¼æ˜ å°„åˆ°é¢œè‰²æ± çš„ç´¢å¼•
        const index = Math.abs(hash) % COLOR_POOL.length;
        const color = COLOR_POOL[index];

        COLOR_CACHE[symbol] = color; // ç¼“å­˜ç»“æœï¼Œç¡®ä¿ä¸‹æ¬¡åˆ·æ–°é¢œè‰²ä¸å˜
        return color;
    }

    let selectedIntervals = JSON.parse(localStorage.getItem("selectedIntervals") || "[]");
    if(selectedIntervals.length === 0) selectedIntervals = defaultSelected;

    const intervalContainer = document.getElementById("intervalButtons");
    INTERVALS.forEach(i=>{
        const btn = document.createElement("button");
        btn.innerText = i;
        btn.style.margin = "2px";
        btn.style.padding = "2px 6px";
        btn.style.fontSize = "12px";
        btn.style.border = "1px solid #ccc";
        btn.style.borderRadius = "4px";
        btn.style.background = selectedIntervals.includes(i) ? "#0d6efd" : "#fff";
        btn.style.color = selectedIntervals.includes(i) ? "#fff" : "#000";
        btn.onclick = () => {
            if(selectedIntervals.includes(i)){
                selectedIntervals = selectedIntervals.filter(x=>x!==i);
                btn.style.background="#fff"; btn.style.color="#000";
            } else {
                selectedIntervals.push(i);
                btn.style.background="#0d6efd"; btn.style.color="#fff";
            }
            localStorage.setItem("selectedIntervals", JSON.stringify(selectedIntervals));
            fetchRankData(true);
        };
        intervalContainer.appendChild(btn);
    });

    // ----------- æ¶¨å¹…æ¦œåˆ·æ–° -----------
    // æ–°å¢ï¼šæ ¹æ®æ¶¨å¹…æ•°å€¼è¿”å›èƒŒæ™¯è‰²æ ·å¼çš„è¾…åŠ©å‡½æ•°
    function getColorStyle(value) {
        if (!value) return "";
        const num = parseFloat(value);
        if (num > 10) return "background-color: #dc3545; color: white; font-weight: bold;"; // çº¢è‰² (>10)
        if (num > 7)  return "background-color: #fd7e14; color: white; font-weight: bold;"; // æ©™è‰² (>7)
        if (num > 4)  return "background-color: #ffc107; color: black; font-weight: bold;"; // é»„è‰² (>4)
        return ""; // é»˜è®¤æ— æ ·å¼
    }

    async function fetchRankData(forceUpdate = false) {
        try {
            const res = await fetch('/data', {cache: "no-store"});
            const data = await res.json();

            const currentJson = JSON.stringify(data);
            if (data["5m"].change.length === 0) {
                errorAlert();
                return;
            }
            if (!forceUpdate && currentJson === lastRankJson) {// åªæœ‰éå¼ºåˆ¶åˆ·æ–°æ‰åˆ¤æ–­
                errorAlert(100);
                return;
            }
            updateLastChangeTime();
            lastRankJson = currentJson;
            console.log("æ¶¨å¹…æ¦œæ•°æ®æ›´æ–°ï¼š", currentJson)
            let changeHtml = '';
            errNum = 0;
            INTERVALS.forEach(interval => {
                // 1. è¿‡æ»¤å’Œæ•°æ®æ£€æŸ¥
                if (!selectedIntervals.includes(interval)) return; // æœªé€‰ä¸­ï¼Œè·³è¿‡
                if (!data[interval]) return;

                // 2. è·å– intervalNumber
                const numberString = interval.replace('m', '');
                const intervalNumber = parseInt(numberString, 10);
                const changeList = data[interval].change.slice(0, TOP_NUM);

                // --- åŠ¨æ€è¡¨å¤´é€»è¾‘ ---
                let dynamicHeaderHtml = '';

                // åœ¨ JavaScript ä¸­è¿›è¡Œåˆ¤æ–­ï¼Œç”Ÿæˆè¡¨å¤´å­—ç¬¦ä¸²
                if (intervalNumber <= 60) {
                    dynamicHeaderHtml = `
                    <th>60åˆ†æ¶¨å¹…(%)</th>
                    <th>60åˆ†æŒ¯å¹…(%)</th>
                `;
                } else {
                    dynamicHeaderHtml = `
                    <th>${intervalNumber}åˆ†æ¶¨å¹…(%)</th>
                    <th>${intervalNumber}åˆ†æŒ¯å¹…(%)</th>
                `;
                }

                // 3. æ‹¼æ¥è¡¨æ ¼å¼€å§‹éƒ¨åˆ†ï¼ˆåŒ…å«åŠ¨æ€è¡¨å¤´ï¼‰
                changeHtml += `<div class="table-container">
                <h2>${interval} K çº¿ Top ${TOP_NUM} æ¶¨å¹…</h2>
                <table>
                    <tr>
                        <th>æ’å</th><th>äº¤æ˜“å¯¹</th>
                        <th>5åˆ†æ¶¨å¹…(%)</th><th>5åˆ†æŒ¯å¹…(%)</th>
                        <th>15åˆ†æ¶¨å¹…(%)</th><th>15åˆ†æŒ¯å¹…(%)</th>
                        <th>30åˆ†æ¶¨å¹…(%)</th><th>30åˆ†æŒ¯å¹…(%)</th>
                        ${dynamicHeaderHtml} <th>æ”¶ç›˜</th>
                    </tr>`;

                // 4. éå†è¡¨æ ¼è¡Œæ•°æ®
                changeList.forEach((c, i) => {
                    // ğŸŒŸ è·å–è¯¥å¸ç§çš„ç¨³å®šèƒŒæ™¯è‰²
                    const rowBgColor = getSymbolBackgroundColor(c.symbol);

                    // è·å– 5åˆ†é’Ÿæ¶¨å¹…çš„æ•°æ®
                    const change5m = c.others && c.others['5m'] ? c.others['5m'].change : 0;
                    // è®¡ç®— 5åˆ†é’Ÿè¿™ä¸€æ ¼çš„æ ·å¼
                    const style5m = getColorStyle(change5m);

                    // --- åŠ¨æ€è¡Œæ•°æ®é€»è¾‘ ---
                    let dynamicRowDataHtml = '';

                    // åœ¨ JavaScript ä¸­è¿›è¡Œåˆ¤æ–­ï¼Œç”Ÿæˆè¡Œæ•°æ®å­—ç¬¦ä¸²
                    if (intervalNumber <= 60) {
                        // å¼•ç”¨ '60m' çš„æ•°æ®
                        dynamicRowDataHtml = `
                        <td>${c.others && c.others['60m'] ? c.others['60m'].change.toFixed(2) : '-'}</td>
                        <td>${c.others && c.others['60m'] ? c.others['60m'].amplitude.toFixed(2) : '-'}</td>
                    `;
                    } else {
                        // å¼•ç”¨å½“å‰ interval (å¦‚ '120m') çš„æ•°æ®
                        dynamicRowDataHtml = `
                        <td>${c.others && c.others[interval] ? c.others[interval].change.toFixed(2) : '-'}</td>
                        <td>${c.others && c.others[interval] ? c.others[interval].amplitude.toFixed(2) : '-'}</td>
                    `;
                    }

                    // 5. æ‹¼æ¥å®Œæ•´çš„è¡¨æ ¼è¡Œ
                    changeHtml += `<tr style="background-color: ${rowBgColor};">
                    <td>${i + 1}</td>
                    <td>${c.symbol}</td>

                    <td style="${style5m}">${change5m ? Number(change5m).toFixed(2) : '-'}</td>
                    <td>${c.others && c.others['5m'] ? c.others['5m'].amplitude.toFixed(2) : '-'}</td>

                    <td>${c.others && c.others['15m'] ? c.others['15m'].change.toFixed(2) : '-'}</td>
                    <td>${c.others && c.others['15m'] ? c.others['15m'].amplitude.toFixed(2) : '-'}</td>
                    <td>${c.others && c.others['30m'] ? c.others['30m'].change.toFixed(2) : '-'}</td>
                    <td>${c.others && c.others['30m'] ? c.others['30m'].amplitude.toFixed(2) : '-'}</td>

                    ${dynamicRowDataHtml} <td>${c.close.toFixed(5)}</td>
                </tr>`;
                });

                // 6. æ‹¼æ¥è¡¨æ ¼ç»“æŸæ ‡ç­¾
                changeHtml += `</table></div>`;
            });

            document.getElementById('change-tables').innerHTML = changeHtml;

            // æ¶¨å¹…æé†’
            if (data["5m"]) {
                const list5m = data["5m"].change;

                const maxChange = Math.max(...list5m.map(c => Number(c.change)));
                if (maxChange >= threshold) {
                    const audio = document.getElementById("alertSound");
                    audio.volume = 1;
                    audio.currentTime = 0;
                    audio.play().catch(() => {
                    });
                    console.log("æ¶¨å¹…è¶…è¿‡é˜ˆå€¼ï¼Œå·²æé†’ä¸€æ¬¡ï¼");
                }
            }

        } catch (err) {
            errorAlert();
            console.error("æ•°æ®åˆ·æ–°é”™è¯¯ï¼š", err);
        }
    }

    // ----------- å¼ºåŠ¿å¸é€šçŸ¥æ¡åˆ·æ–° -----------
    async function fetchStrongData() {
        try{
            const res = await fetch('/strong', { cache: "no-store" });
            const data = await res.json();

            const currentJson = JSON.stringify(data);
            if(currentJson === lastStrongJson) return;
            lastStrongJson = currentJson;
            console.log("å¼ºåŠ¿å¸æ•°æ®æ›´æ–°ï¼š",currentJson)
            const container = document.getElementById('strong-notice');
            container.innerHTML = data.map(c => `<span class="strong-coin">${c.symbol}</span>`).join(' ');

            if(data.length > 0){
                const audio = document.getElementById("alertSoundStrong");
                audio.volume = 1;
                audio.currentTime = 0;
                audio.play().catch(()=>{});
                console.log("å‘ç°æ–°çš„å¼ºåŠ¿å¸ï¼Œå·²æ’­æ”¾æé†’éŸ³");
            }

        } catch(err){ console.error("å¼ºåŠ¿å¸åˆ·æ–°é”™è¯¯ï¼š", err); }
    }

    // ----------- å®šæ—¶åˆ·æ–° -----------
    function startTimer(){
        if(timer) clearInterval(timer);
        timer = setInterval(()=>{
            fetchRankData();
            fetchStrongData();
        }, refreshSeconds*1000);
        document.getElementById('refreshStatus').innerText = "æ­£åœ¨åˆ·æ–°";
        document.getElementById('refreshStatus').style.color = "green";
        console.log("è‡ªåŠ¨åˆ·æ–°å·²å¯åŠ¨ï¼Œé—´éš”:", refreshSeconds,"ç§’");
        fetchRankData();
        fetchStrongData();
    }

    function stopTimer(){
        if(timer){
            clearInterval(timer);
            timer=null;
            document.getElementById('refreshStatus').innerText = "å·²åœæ­¢åˆ·æ–°";
            document.getElementById('refreshStatus').style.color = "red";
            console.log("è‡ªåŠ¨åˆ·æ–°å·²åœæ­¢");
        }
    }

    function restartAutoRefresh(){
        const v = parseInt(document.getElementById('refreshInterval').value);
        if(!isNaN(v) && v>=5 && v<=600) refreshSeconds = v;
        startTimer();
    }
    // æ•°æ®å‘ç”Ÿå˜åŒ– â†’ è®°å½•æ›´æ–°æ—¶é—´
    function updateLastChangeTime() {
        const now = new Date();
        const pad = n => (n < 10 ? "0" + n : n);
        const str =
            now.getFullYear() + "-" +
            pad(now.getMonth() + 1) + "-" +
            pad(now.getDate()) + " " +
            pad(now.getHours()) + ":" +
            pad(now.getMinutes()) + ":" +
            pad(now.getSeconds());

        document.getElementById("lastUpdateTime").innerText = str;
    }

    function updateCurrentTime() {
        const now = new Date();
        const pad = n => (n < 10 ? "0" + n : n);
        const str =
            now.getFullYear() + "-" +
            pad(now.getMonth() + 1) + "-" +
            pad(now.getDate()) + " " +
            pad(now.getHours()) + ":" +
            pad(now.getMinutes()) + ":" +
            pad(now.getSeconds());

        document.getElementById("currentTime").innerText = str;
    }

    function errorAlert(MAX_NUM=20){
        errNum++;
        if (errNum >= MAX_NUM) {
            const audio = document.getElementById("alertError");
            audio.volume = 1;
            audio.currentTime = 0;
            audio.play().catch(() => {
            });
            errNum=0;
            console.log("æ•°æ®åˆ·æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜ï¼");
        }
    }

    setInterval(updateCurrentTime, 1000);
    updateCurrentTime();
    startTimer();
</script>
</body>
</html>

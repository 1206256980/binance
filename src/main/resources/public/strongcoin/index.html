<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Binance 强势币监控</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 10px; background: #f9f9f9; }
        h1 { text-align: center; }
        #controls { text-align: center; margin-bottom: 10px; }
        table { border-collapse: collapse; width: 100%; font-size: 12px; }
        th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }
        th { background: #eee; }
        tr:hover { background: #f1f1f1; }
        .top-table { max-width: 1200px; margin: 0 auto; background: #fff; padding: 10px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
    </style>
</head>
<body>
<h1>Binance 强势币 Top 20</h1>

<div id="controls">
    刷新间隔（秒）：
    <input type="number" id="refreshInterval" value="0.5" min="0.1" max="10" step="0.1" style="width:50px;">
    <button onclick="restartAutoRefresh()">应用</button>
    <button onclick="startTimer()">开始</button>
    <button onclick="stopTimer()">停止</button>
    状态：<span id="refreshStatus" style="color:green">正在刷新</span>
</div>

<div id="table-container" class="top-table"></div>

<audio id="alertSound">
    <source src="/alert.wav" type="audio/wav">
</audio>

<script>
    let refreshSeconds = 0.5;
    let timer = null;
    let lastJson = "";
    const TOP_NUM = 20;
    const threshold = 5; // 涨幅提醒阈值 %

    async function fetchData() {
        try {
            const res = await fetch('/data', { cache: "no-store" });
            const data = await res.json();

            const currentJson = JSON.stringify(data);
            if(currentJson === lastJson){
                // 数据无变化，不刷新
                return;
            }
            lastJson = currentJson;

            let html = `<table>
        <tr>
            <th>排名</th>
            <th>交易对</th>
            <th>累计涨幅(%)</th>
            <th>当前价</th>
            <th>成交额(M)</th>
            <th>5m涨幅(%)</th>
            <th>30m涨幅(%)</th>
            <th>30m振幅(%)</th>
        </tr>`;

            const list = data.slice(0, TOP_NUM);
            list.forEach((c, i) => {
                html += `<tr>
                <td>${i+1}</td>
                <td>${c.symbol}</td>
                <td>${c.cumulativeChange.toFixed(2)}</td>
                <td>${c.currentPrice.toFixed(5)}</td>
                <td>${(c.maxVolumeUSDT/1000000).toFixed(2)}</td>
                <td>${c.change5m.toFixed(2)}</td>
                <td>${c.change30m.toFixed(2)}</td>
                <td>${c.amplitude30m.toFixed(2)}</td>
            </tr>`;
            });

            html += `</table>`;
            document.getElementById('table-container').innerHTML = html;

            // 涨幅提醒
            if(list.length>0) {
                const maxChange = Math.max(...list.map(c => Number(c.cumulativeChange)));
                if(maxChange >= threshold) {
                    const audio = document.getElementById("alertSound");
                    audio.volume = 0.3;
                    audio.currentTime = 0;
                    audio.play().catch(() => {});
                    console.log("涨幅超过阈值，已提醒一次！");
                }
            }

        } catch(err) {
            console.error("数据刷新错误：", err);
        }
    }

    function startTimer() {
        if(timer) clearInterval(timer);
        timer = setInterval(fetchData, refreshSeconds*1000);
        document.getElementById('refreshStatus').innerText = "正在刷新";
        document.getElementById('refreshStatus').style.color = "green";
        fetchData();
    }

    function stopTimer() {
        if(timer) {
            clearInterval(timer);
            timer = null;
            document.getElementById('refreshStatus').innerText = "已停止刷新";
            document.getElementById('refreshStatus').style.color = "red";
        }
    }

    function restartAutoRefresh() {
        const v = parseFloat(document.getElementById('refreshInterval').value);
        if(!isNaN(v) && v>0) {
            refreshSeconds = v;
        }
        startTimer();
    }

    // 启动
    startTimer();
</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Binance Top 涨幅 & 振幅</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 10px; background: #f9f9f9; }
        h1 { text-align: center; }
        #controls { text-align: center; margin-bottom: 10px; }
        #tables {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #change-tables, #amplitude-tables {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        .table-container {
            background: #fff;
            padding: 8px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            width: 440px;
        }
        table { border-collapse: collapse; width: 100%; font-size:10px; }
        th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }
        th { background: #eee; }
        h2 { text-align: center; margin-top: 0; font-size: 14px; }
    </style>
</head>
<body>

<div id="controls">
    <label>刷新间隔（秒）：
        <input type="number" id="refreshInterval" value="60" min="5" max="600" style="width:50px;">
    </label>
    <button onclick="restartAutoRefresh()">应用</button>
    <button onclick="startTimer()">开始</button>
    <button onclick="stopTimer()">停止</button>
    &nbsp;&nbsp;状态：<span id="refreshStatus">正在刷新</span>
</div>

<div id="tables">
    <div id="change-tables"></div>
    <div id="amplitude-tables"></div>
</div>
<audio id="alertSound">
    <source src="/alert.wav" type="audio/wav">
</audio>

<script>
    let refreshSeconds = 0.5;
    let timer = null;
    let lastJson = "";
    const TOP_NUM = 20;
    const threshold = 3;

    async function fetchData() {
        try {
            const res = await fetch('/data', { cache: "no-store" });
            const data = await res.json();

            const currentJson = JSON.stringify(data);
            if(currentJson === lastJson){
                console.log("数据无变化，不刷新页面");
                return;
            }
            lastJson = currentJson;

            let changeHtml = '';
            let amplitudeHtml = '';

            Object.keys(data).forEach(interval => {
                const changeList = data[interval].change.slice(0, TOP_NUM);
                changeHtml += `<div class="table-container">
                    <h2>${interval} K 线 Top ${TOP_NUM} 涨幅</h2>
                    <table>
                        <tr>
                            <th>排名</th>
                            <th>交易对</th>
                            <th>5分涨幅(%)</th>
                            <th>5分振幅(%)</th>
                            <th>15分涨幅(%)</th>
                            <th>15分振幅(%)</th>
                            <th>30分涨幅(%)</th>
                            <th>30分振幅(%)</th>
                            <th>收盘</th>
                        </tr>`;
                changeList.forEach((c, i) => {
                    changeHtml += `<tr>
                        <td>${i+1}</td>
                        <td>${c.symbol}</td>
                        <td>${c.others && c.others['5m'] ? c.others['5m'].change.toFixed(2) : '-'}</td>
                        <td>${c.others && c.others['5m'] ? c.others['5m'].amplitude.toFixed(2) : '-'}</td>
                        <td>${c.others && c.others['15m'] ? c.others['15m'].change.toFixed(2) : '-'}</td>
                        <td>${c.others && c.others['15m'] ? c.others['15m'].amplitude.toFixed(2) : '-'}</td>
                        <td>${c.others && c.others['30m'] ? c.others['30m'].change.toFixed(2) : '-'}</td>
                        <td>${c.others && c.others['30m'] ? c.others['30m'].amplitude.toFixed(2) : '-'}</td>
                        <td>${c.close.toFixed(5)}</td>
                    </tr>`;
                });
                changeHtml += `</table></div>`;

                const amplitudeList = data[interval].amplitude.slice(0, TOP_NUM);
                amplitudeHtml += `<div class="table-container">
                    <h2>${interval} K 线 Top ${TOP_NUM} 振幅</h2>
                    <table>
                        <tr>
                            <th>排名</th>
                            <th>交易对</th>
                            <th>5分涨幅(%)</th>
                            <th>5分振幅(%)</th>
                            <th>15分涨幅(%)</th>
                            <th>15分振幅(%)</th>
                            <th>30分涨幅(%)</th>
                            <th>30分振幅(%)</th>
                            <th>收盘</th>
                        </tr>`;
                amplitudeList.forEach((c, i) => {
                    amplitudeHtml += `<tr>
                        <td>${i+1}</td>
                        <td>${c.symbol}</td>
                        <td>${c.others && c.others['5m'] ? c.others['5m'].change.toFixed(2) : '-'}</td>
                        <td>${c.others && c.others['5m'] ? c.others['5m'].amplitude.toFixed(2) : '-'}</td>
                        <td>${c.others && c.others['15m'] ? c.others['15m'].change.toFixed(2) : '-'}</td>
                        <td>${c.others && c.others['15m'] ? c.others['15m'].amplitude.toFixed(2) : '-'}</td>
                        <td>${c.others && c.others['30m'] ? c.others['30m'].change.toFixed(2) : '-'}</td>
                        <td>${c.others && c.others['30m'] ? c.others['30m'].amplitude.toFixed(2) : '-'}</td>
                        <td>${c.close.toFixed(5)}</td>
                    </tr>`;
                });
                amplitudeHtml += `</table></div>`;
            });

            document.getElementById('change-tables').innerHTML = changeHtml;
            document.getElementById('amplitude-tables').innerHTML = amplitudeHtml;

            // ========= 涨幅提醒逻辑 =========
            if (data["5m"]) {
                const list5m = data["5m"].change;
                const maxChange = Math.max(...list5m.map(c => Number(c.change)));
                if (maxChange >= threshold) {
                    const audio = document.getElementById("alertSound");
                    audio.volume = 0.3;
                    audio.currentTime = 0;
                    audio.play().catch(() => {});
                    console.log("涨幅超过阈值，已提醒一次！");
                }
            }

        } catch (err) {
            console.error("数据刷新错误：", err);
        }
    }

    function startTimer() {
        if (timer) clearInterval(timer);
        timer = setInterval(fetchData, refreshSeconds * 1000);
        document.getElementById('refreshStatus').innerText = "正在刷新";
        document.getElementById('refreshStatus').style.color = "green";
        console.log("自动刷新已启动，间隔:", refreshSeconds, "秒");
        fetchData();
    }

    function stopTimer() {
        if (timer) {
            clearInterval(timer);
            timer = null;
            document.getElementById('refreshStatus').innerText = "已停止刷新";
            document.getElementById('refreshStatus').style.color = "red";
            console.log("自动刷新已停止");
        }
    }

    function restartAutoRefresh() {
        const v = parseInt(document.getElementById('refreshInterval').value);
        if (!isNaN(v) && v >= 5 && v <= 600) {
            refreshSeconds = v;
            console.log("刷新间隔已更新:", refreshSeconds, "秒");
        }
        startTimer();
    }

    startTimer();
</script>
</body>
</html>

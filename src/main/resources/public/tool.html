<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šåŠŸèƒ½è®¡ç®—å·¥å…·ç®± - æœ€ç»ˆç¨³å®šå¸ƒå±€</title>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
            color: #333;
            box-sizing: border-box;
            /* ç¡®ä¿ padding åŒ…å«åœ¨ body å®½åº¦å†… */
        }

        .container {
            width: 100%;
            margin: 0 auto;
            background: white;
            padding: 20px 20px 0 20px;
            /* åº•éƒ¨ä¸ç•™ padding, é—´è·ç”± tools-grid å†³å®š */
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }

        h1 {
            color: #17a2b8;
            text-align: center;
        }

        /* --- å…³é”®å¸ƒå±€æ ·å¼ï¼šç§»é™¤ gapï¼Œä½¿ç”¨è´Ÿå¤–è¾¹è·æŠµæ¶ˆå†…éƒ¨æ¨¡å—è¾¹è· --- */
        .tools-grid {
            display: flex;
            flex-wrap: wrap;
            margin-left: -10px;
            /* æŠµæ¶ˆå·¦ä¾§é—´è· */
            margin-right: -10px;
            /* æŠµæ¶ˆå³ä¾§é—´è· */
            margin-bottom: 20px;
        }

        /* --- å·¥å…·æ¨¡å—æ ·å¼ï¼šç²¾ç¡®è®¡ç®—å®½åº¦å’Œé—´è· --- */
        .calculator-section {
            /* å…³é”®ä¿®æ”¹ 1: ä½¿ç”¨ margin æ¨¡æ‹Ÿ 10px å·¦å³é—´è·å’Œ 20px ä¸‹æ–¹é—´è· */
            margin-left: 10px;
            margin-right: 10px;
            margin-bottom: 20px;

            /* å…³é”®ä¿®æ”¹ 2: ç¡®ä¿è®¡ç®—åçš„å®½åº¦èƒ½ç¨³å®šå æ® 1/3ï¼Œå¹¶é˜»æ­¢è¢«å‹ç¼© */
            flex: 0 0 calc(33.333333% - 20px);
            /* å‡å» å·¦å³ 10px marginï¼Œå…± 20px */
            min-width: 280px;
            /* è®¾ç½®ä¸€ä¸ªåˆç†çš„æœ€å°å®½åº¦ */

            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            box-sizing: border-box;
        }

        .placeholder {
            border: 1px dashed #ced4da;
            background-color: #f8f9fa;
        }

        /* --- å†…éƒ¨å…ƒç´ æ ·å¼ (ä¿æŒä¸å˜) --- */
        h2 {
            color: #007bff;
            border-left: 5px solid #007bff;
            padding-left: 10px;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .input-group {
            margin-bottom: 10px;
        }

        .input-group label {
            display: block;
            margin-bottom: 3px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .input-group input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .result {
            margin-top: 15px;
            padding: 10px;
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-weight: bold;
            min-height: 20px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .result:hover {
            background-color: #d1e2f0;
        }

        .result span {
            color: #dc3545;
        }

        .copy-hint {
            font-size: 0.75em;
            color: #6c757d;
            margin-left: 5px;
        }

        /* å¤åˆ¶æˆåŠŸçš„æç¤º */
        #copyMessage {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .visible {
            opacity: 1 !important;
        }
    </style>
</head>

<body>

    <div class="container">

        <div id="copyMessage">âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼</div>

        <div class="tools-grid">

            <div class="calculator-section">
                <h2>1. ğŸ“ˆ ä»·æ ¼ç™¾åˆ†æ¯”å˜åŒ–</h2>
                <p style="font-size: 0.8em; color: #6c757d;">å…¬å¼ï¼š$((ç»“æŸä»· - èµ·å§‹ä»·) / èµ·å§‹ä»·) \times 100\%$</p>

                <div class="input-group">
                    <label for="startPrice">èµ·å§‹ä»·ï¼š</label>
                    <input type="number" id="startPrice" placeholder="å¦‚ 0.4974" oninput="calculatePercentageChange()">
                </div>

                <div class="input-group">
                    <label for="endPrice">ç»“æŸä»·ï¼š</label>
                    <input type="number" id="endPrice" placeholder="å¦‚ 0.5011" oninput="calculatePercentageChange()">
                </div>

                <div class="result" onclick="copyResult('percentageChangeResult')">
                    å˜åŒ–ï¼š<span id="percentageChangeResult"></span>
                    <span class="copy-hint">(ç‚¹å‡»å¤åˆ¶)</span>
                </div>
            </div>

            <div class="calculator-section">
                <h2>2. ğŸ’° ä»·æ ¼ç™¾åˆ†æ¯”è°ƒæ•´</h2>
                <p style="font-size: 0.8em; color: #6c757d;">å…¬å¼ï¼š$ä»·æ ¼ \times (1 + ç™¾åˆ†æ¯”)$</p>
                <p style="font-size: 0.7em; color: #6c757d;">(ç™¾åˆ†æ¯”è¯·æŒ‰æ•´æ•°è¾“å…¥ï¼Œå¦‚ 5 æˆ– -2)</p>

                <div class="input-group">
                    <label for="originalPrice">è¾“å…¥ä»·æ ¼ï¼š</label>
                    <input type="number" id="originalPrice" placeholder="è¯·è¾“å…¥åŸå§‹ä»·æ ¼" oninput="calculateAdjustedPrice()">
                </div>

                <div class="input-group">
                    <label for="percentage">è°ƒæ•´ç™¾åˆ†æ¯” (%)ï¼š</label>
                    <input type="number" id="percentage" placeholder="è¯·è¾“å…¥ç™¾åˆ†æ¯”" oninput="calculateAdjustedPrice()">
                </div>

                <div class="result" onclick="copyResult('adjustedPriceResult')">
                    ç»“æœï¼š<span id="adjustedPriceResult"></span>
                    <span class="copy-hint">(ç‚¹å‡»å¤åˆ¶)</span>
                </div>
            </div>

            <div class="calculator-section" style="flex: 0 0 calc(100% - 20px); min-width: 100%;">
                <h2>3. ğŸ“Š é©¬ä¸è¡¥ä»“è®¡ç®—å™¨</h2>
                <p style="font-size: 0.8em; color: #6c757d;">æ”¯æŒå¤šç»„è®¡ç®—ï¼Œæ¯ç»„æœ‰ç‹¬ç«‹çš„èµ·å§‹ä»·å’Œè¡¥ä»“åˆ—è¡¨</p>

                <!-- å…¨å±€ä¿è¯é‡‘è®¾ç½® -->
                <div
                    style="margin-bottom: 20px; padding: 15px; background: #eef7ff; border-radius: 8px; border: 1px solid #b3d7ff;">
                    <label style="font-weight: bold; font-size: 1.1em; color: #0056b3;">ğŸ’° å…¨ä»“é’±åŒ…ä½™é¢ (å…±äº«ä¿è¯é‡‘)ï¼š</label>
                    <input type="number" id="globalWalletBalance" placeholder="è¾“å…¥å…¨ä»“æ€»å¯ç”¨ä½™é¢" step="any"
                        style="padding: 10px; border: 2px solid #007bff; border-radius: 6px; width: 200px; font-size: 1em;"
                        onchange="handleGlobalWalletBalanceInput(this.value)">
                    <p style="font-size: 0.85em; color: #666; margin-top: 8px; margin-bottom: 0;">
                        ğŸ’¡ åœ¨å…¨ä»“æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰ä»“ä½å…±ç”¨æ­¤ä¿è¯é‡‘ã€‚å¼ºå¹³ä»·ä¼šæ ¹æ®æ­¤ä½™é¢åŠå…¶ä»–ä»“ä½çš„ç›ˆäºè‡ªåŠ¨åŠ¨æ€è®¡ç®—ã€‚
                    </p>
                </div>

                <div id="dcaGroupsContainer">
                    <!-- åŠ¨æ€ç”Ÿæˆçš„è®¡ç®—ç»„ä¼šæ”¾åœ¨è¿™é‡Œ -->
                </div>

                <button onclick="addDCAGroup()"
                    style="margin-top: 15px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em;">
                    â• æ–°å¢è®¡ç®—ç»„
                </button>
                <span id="dcaSyncStatus" style="margin-left: 15px; font-size: 0.85em; color: #6c757d;"></span>
            </div>
        </div>
    </div>
    </div>

    <script>
        // ========== é©¬ä¸è¡¥ä»“è®¡ç®—å™¨ - å¤šç»„æ”¯æŒ ==========
        let dcaGroups = []; // å­˜å‚¨æ‰€æœ‰è®¡ç®—ç»„
        let groupIdCounter = 0;
        let globalRowIdCounter = 0;
        let dcaGlobalWalletBalance = ''; // ğŸŒŸ æ–°å¢ï¼šå…¨å±€é’±åŒ…ä½™é¢

        // è·å–æ•°å­—çš„å°æ•°ä½æ•°
        function getDecimalPlaces(numStr) {
            if (!numStr || numStr === '') return 4;
            const str = numStr.toString();
            const dotIndex = str.indexOf('.');
            if (dotIndex === -1) return 0;
            return str.length - dotIndex - 1;
        }

        // æ·»åŠ æ–°çš„è®¡ç®—ç»„
        function addDCAGroup() {
            const groupId = groupIdCounter++;
            const group = {
                id: groupId,
                coinName: '',
                basePrice: '',
                includeInMargin: true, // ğŸŒŸ æ–°å¢ï¼šæ˜¯å¦è®¡å…¥å…¨ä»“ä¿è¯é‡‘
                rows: []
            };
            // é»˜è®¤æ·»åŠ 3è¡Œ
            for (let i = 0; i < 3; i++) {
                group.rows.push({ id: globalRowIdCounter++, rise: '', price: '', position: '' });
            }
            dcaGroups.push(group);
            renderAllGroups();
            saveDCAToStorage();
        }

        // åˆ é™¤è®¡ç®—ç»„
        function removeDCAGroup(groupId) {
            dcaGroups = dcaGroups.filter(g => g.id !== groupId);
            renderAllGroups();
            saveDCAToStorage();
        }

        // æ·»åŠ è¡¥ä»“è¡Œï¼ˆåœ¨æŒ‡å®šè¡Œåæ’å…¥ï¼Œå¦‚æœä¸æŒ‡å®šåˆ™æ·»åŠ åˆ°æœ«å°¾ï¼‰
        function addDCARow(groupId, afterRowId = null) {
            const group = dcaGroups.find(g => g.id === groupId);
            if (group) {
                const newRow = { id: globalRowIdCounter++, rise: '', price: '', position: '' };
                if (afterRowId !== null) {
                    const afterIndex = group.rows.findIndex(r => r.id === afterRowId);
                    if (afterIndex !== -1) {
                        group.rows.splice(afterIndex + 1, 0, newRow);
                    } else {
                        group.rows.push(newRow);
                    }
                } else {
                    group.rows.push(newRow);
                }
                renderGroup(groupId);
                saveDCAToStorage();
            }
        }

        // åˆ é™¤è¡¥ä»“è¡Œ
        function removeDCARow(groupId, rowId) {
            const group = dcaGroups.find(g => g.id === groupId);
            if (group) {
                group.rows = group.rows.filter(r => r.id !== rowId);
                renderGroup(groupId);
                calculateDCA(groupId);
                saveDCAToStorage();
            }
        }

        // æ¸…é™¤å­—æ®µ
        function clearDCAField(groupId, rowId, field) {
            const group = dcaGroups.find(g => g.id === groupId);
            if (group) {
                const row = group.rows.find(r => r.id === rowId);
                if (row) {
                    row[field] = '';
                    renderGroup(groupId);
                    saveDCAToStorage();
                }
            }
        }

        // å¤„ç†å¸åè¾“å…¥
        function handleCoinNameInput(groupId, value) {
            const group = dcaGroups.find(g => g.id === groupId);
            if (group) {
                group.coinName = value;
                // æ›´æ–°æ ‡é¢˜
                const titleEl = document.getElementById(`groupTitle_${groupId}`);
                if (titleEl) {
                    titleEl.textContent = `ğŸ“ˆ è®¡ç®—ç»„ ${dcaGroups.findIndex(g => g.id === groupId) + 1}${value ? ' - ' + value : ''}`;
                }
                saveDCAToStorage();
            }
        }

        // å¤„ç†èµ·å§‹ä»·è¾“å…¥
        function handleBasePriceInput(groupId, value) {
            const group = dcaGroups.find(g => g.id === groupId);
            if (group) {
                group.basePrice = value;
                renderGroup(groupId);
                saveDCAToStorage();
            }
        }

        // å¤„ç†ä¿è¯é‡‘è®¡ç®—å¼€å…³
        function handleMarginToggle(groupId, checked) {
            const group = dcaGroups.find(g => g.id === groupId);
            if (group) {
                group.includeInMargin = checked;
                calculateDCA();
                saveDCAToStorage();
            }
        }

        // å¤„ç†è¡Œè¾“å…¥
        function handleDCAInput(groupId, rowId, field, value) {
            const group = dcaGroups.find(g => g.id === groupId);
            if (!group) return;

            const row = group.rows.find(r => r.id === rowId);
            if (!row) return;

            row[field] = value;
            const basePrice = parseFloat(group.basePrice);
            const priceDecimals = getDecimalPlaces(group.basePrice);

            // äº’æ–¥é€»è¾‘
            if (field === 'rise' && value !== '') {
                row.price = '';
                const priceInput = document.getElementById(`price_${groupId}_${rowId}`);
                if (priceInput && !isNaN(basePrice) && basePrice > 0) {
                    const rise = parseFloat(value);
                    if (!isNaN(rise)) {
                        priceInput.value = (basePrice * (1 + rise / 100)).toFixed(priceDecimals);
                    }
                }
            } else if (field === 'price' && value !== '') {
                row.rise = '';
                const riseInput = document.getElementById(`rise_${groupId}_${rowId}`);
                if (riseInput && !isNaN(basePrice) && basePrice > 0) {
                    const price = parseFloat(value);
                    if (!isNaN(price)) {
                        riseInput.value = (((price - basePrice) / basePrice) * 100).toFixed(2);
                    }
                }
            }

            calculateDCA(groupId);
            saveDCAToStorage();
        }

        // æ¸²æŸ“æ‰€æœ‰ç»„
        function renderAllGroups() {
            const container = document.getElementById('dcaGroupsContainer');
            container.innerHTML = '';

            dcaGroups.forEach((group, index) => {
                const groupDiv = document.createElement('div');
                groupDiv.id = `dcaGroup_${group.id}`;
                groupDiv.style.cssText = 'margin-bottom: 25px; padding: 15px; border: 2px solid #007bff; border-radius: 8px; background: #f8f9ff;';

                groupDiv.innerHTML = generateGroupHTML(group, index);
                container.appendChild(groupDiv);

                calculateDCA(group.id);
            });
        }

        // æ¸²æŸ“å•ä¸ªç»„
        function renderGroup(groupId) {
            const group = dcaGroups.find(g => g.id === groupId);
            if (!group) return;

            const groupDiv = document.getElementById(`dcaGroup_${groupId}`);
            if (!groupDiv) {
                renderAllGroups();
                return;
            }

            const index = dcaGroups.findIndex(g => g.id === groupId);
            groupDiv.innerHTML = generateGroupHTML(group, index);
            calculateDCA(groupId);
        }

        // ç”Ÿæˆç»„çš„HTML
        function generateGroupHTML(group, index) {
            const basePrice = parseFloat(group.basePrice);
            const priceDecimals = getDecimalPlaces(group.basePrice);


            let rowsHTML = '';
            group.rows.forEach((row, rowIndex) => {

                let displayRise = row.rise;
                let displayPrice = row.price;

                if (!isNaN(basePrice) && basePrice > 0) {
                    if (row.rise !== '' && row.price === '') {
                        const rise = parseFloat(row.rise);
                        if (!isNaN(rise)) {
                            displayPrice = (basePrice * (1 + rise / 100)).toFixed(priceDecimals);
                        }
                    } else if (row.price !== '' && row.rise === '') {
                        const price = parseFloat(row.price);
                        if (!isNaN(price)) {
                            displayRise = (((price - basePrice) / basePrice) * 100).toFixed(2);
                        }
                    }
                }

                rowsHTML += `
                <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${rowIndex + 1}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">
                        <div style="position: relative; display: inline-block;">
                            <input type="number" id="rise_${group.id}_${row.id}" value="${displayRise}" 
                                   placeholder="å¦‚14" step="any" 
                                   style="width: 80px; padding: 8px 22px 8px 8px; border: 1px solid #ccc; border-radius: 4px;"
                                   onchange="handleDCAInput(${group.id}, ${row.id}, 'rise', this.value)">
                            <span onclick="clearDCAField(${group.id}, ${row.id}, 'rise')" 
                                  style="position: absolute; right: 6px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #aaa; font-size: 16px; font-weight: bold;">&times;</span>
                        </div>
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd;">
                        <div style="position: relative; display: inline-block;">
                            <input type="number" id="price_${group.id}_${row.id}" value="${displayPrice}" 
                                   placeholder="å¦‚1.0097" step="any" 
                                   style="width: 95px; padding: 8px 22px 8px 8px; border: 1px solid #ccc; border-radius: 4px;"
                                   onchange="handleDCAInput(${group.id}, ${row.id}, 'price', this.value)">
                            <span onclick="clearDCAField(${group.id}, ${row.id}, 'price')" 
                                  style="position: absolute; right: 6px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #aaa; font-size: 16px; font-weight: bold;">&times;</span>
                        </div>
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd;">
                        <div style="position: relative; display: inline-block;">
                            <input type="number" id="pos_${group.id}_${row.id}" value="${row.position}" 
                                   placeholder="å¦‚30" step="any" 
                                   style="width: 70px; padding: 8px 22px 8px 8px; border: 1px solid #ccc; border-radius: 4px;"
                                   onchange="handleDCAInput(${group.id}, ${row.id}, 'position', this.value)">
                            <span onclick="clearDCAField(${group.id}, ${row.id}, 'position')" 
                                  style="position: absolute; right: 6px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #aaa; font-size: 16px; font-weight: bold;">&times;</span>
                        </div>
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;" id="cumPos_${group.id}_${row.id}">-</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;" id="avgPrice_${group.id}_${row.id}">-</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;" id="liqPrice_${group.id}_${row.id}">-</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;" id="distPrev_${group.id}_${row.id}">-</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;" id="currLoss_${group.id}_${row.id}">-</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;" id="recovery_${group.id}_${row.id}">-</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                        <button onclick="addDCARow(${group.id}, ${row.id})" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-right: 4px;" title="åœ¨ä¸‹æ–¹æ·»åŠ ä¸€è¡Œ">+</button>
                        <button onclick="removeDCARow(${group.id}, ${row.id})" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;" title="åˆ é™¤æ­¤è¡Œ">Ã—</button>
                    </td>
                </tr>`;
            });

            return `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <h3 id="groupTitle_${group.id}" style="margin: 0; color: #007bff;">ğŸ“ˆ è®¡ç®—ç»„ ${index + 1}${group.coinName ? ' - ' + group.coinName : ''}</h3>
                        <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9em; cursor: pointer; background: #f8f9fa; padding: 4px 8px; border-radius: 4px; border: 1px solid #ddd;">
                            <input type="checkbox" ${group.includeInMargin !== false ? 'checked' : ''} 
                                   onchange="handleMarginToggle(${group.id}, this.checked)">
                            è®¡å…¥å…¨ä»“ä¿è¯é‡‘
                        </label>
                    </div>
                    <button onclick="removeDCAGroup(${group.id})" 
                            style="background: #dc3545; color: white; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer;">
                        ğŸ—‘ï¸ åˆ é™¤æ­¤ç»„
                    </button>
                </div>
                
                <div style="display: flex; gap: 20px; margin-bottom: 15px; align-items: center; flex-wrap: wrap;">
                    <div class="input-group" style="flex: 0 0 auto;">
                        <label style="font-weight: bold; margin-right: 8px;">å¸åï¼š</label>
                        <input type="text" id="coinName_${group.id}" value="${group.coinName || ''}" 
                               placeholder="å¦‚ BTC" 
                               style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100px;"
                               onchange="handleCoinNameInput(${group.id}, this.value)">
                    </div>
                    <div class="input-group" style="flex: 0 0 auto;">
                        <label style="font-weight: bold; margin-right: 8px;">èµ·å§‹ä»·ï¼š</label>
                        <input type="number" id="basePrice_${group.id}" value="${group.basePrice}" 
                               placeholder="å¦‚ 0.8652" step="any" 
                               style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 150px;"
                               onchange="handleBasePriceInput(${group.id}, this.value)">
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                        <thead>
                            <tr style="background: #e9ecef;">
                                <th style="padding: 8px; border: 1px solid #ddd;">è¡¥ä»“</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">æ¶¨å¹…%</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">ä»·æ ¼</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">ä»“ä½</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">ç´¯è®¡ä»“ä½</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">æˆæœ¬ä»·</th>
                                <th style="padding: 8px; border: 1px solid #ddd; color: #dc3545;">å¼ºå¹³ä»·</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">è·ä¸Šæ¬¡%</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">å½“å‰äºæŸ</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">å›æœ¬%</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rowsHTML}
                        </tbody>
                    </table>
                </div>

                <button onclick="addDCARow(${group.id})" 
                        style="margin-top: 10px; padding: 6px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
                    â• æ·»åŠ è¡¥ä»“è¡Œ
                </button>

            `;
        }

        // è®¡ç®—æ‰€æœ‰ç»„çš„DCA
        function calculateDCA(specificGroupId = null) {
            // é¦–å…ˆè®¡ç®—æ¯ä¸ªç»„çš„åŸºæœ¬æ•°æ®å¹¶æ±‡æ€»å…¨å±€ PnL
            const walletBalance = parseFloat(dcaGlobalWalletBalance) || 0;
            let totalRealPosition = 0;
            let totalCost = 0;

            const groupStats = dcaGroups.map(group => {
                const basePrice = parseFloat(group.basePrice);
                let gRealPos = 0;
                let gTotalCost = 0;
                let prevPrice = null;

                if (!isNaN(basePrice) && basePrice > 0) {
                    group.rows.forEach((row, index) => {
                        let price = parseFloat(row.price);
                        if (row.rise !== '' && !isNaN(parseFloat(row.rise))) {
                            price = basePrice * (1 + parseFloat(row.rise) / 100);
                        }
                        const position = parseFloat(row.position);

                        if (!isNaN(price) && price > 0) {
                            if (prevPrice && gRealPos > 0) {
                                gRealPos = gRealPos * (price / prevPrice);
                            }
                            prevPrice = price;
                        }
                        if (!isNaN(price) && !isNaN(position) && position > 0) {
                            gRealPos += position;
                            gTotalCost += position;
                        }
                    });
                }

                // ğŸŒŸ åªæœ‰å¼€å¯äº†å¼€å…³çš„ç»„æ‰è®¡å…¥å…¨å±€ç»Ÿè®¡
                if (group.includeInMargin !== false) {
                    totalRealPosition += gRealPos;
                    totalCost += gTotalCost;
                }

                return { id: group.id, gRealPos, gTotalCost, lastPrice: prevPrice };
            });

            // æ€»æœªå®ç°ç›ˆäº
            const totalPnL = totalRealPosition - totalCost;
            updateSyncStatus(`è´¦æˆ·æ€»äºæŸ: ${totalPnL.toFixed(2)} | ä¿è¯é‡‘: ${walletBalance}`, totalPnL < 0 ? '#dc3545' : '#28a745');

            // å†æ¬¡éå†æ›´æ–° UI
            dcaGroups.forEach(group => {
                const stats = groupStats.find(s => s.id === group.id);
                const basePrice = parseFloat(group.basePrice);
                if (isNaN(basePrice) || basePrice <= 0) return;

                let currentRealPos = 0;
                let currentTotalCost = 0;
                let prevPrice = null;

                group.rows.forEach((row, index) => {
                    let rise = parseFloat(row.rise);
                    let price = parseFloat(row.price);
                    const position = parseFloat(row.position);
                    const priceDecimals = getDecimalPlaces(group.basePrice);

                    if (row.rise !== '' && !isNaN(rise)) {
                        price = basePrice * (1 + rise / 100);
                    }

                    const cumPosEl = document.getElementById(`cumPos_${group.id}_${row.id}`);
                    const avgPriceEl = document.getElementById(`avgPrice_${group.id}_${row.id}`);
                    const liqPriceEl = document.getElementById(`liqPrice_${group.id}_${row.id}`);
                    const distPrevEl = document.getElementById(`distPrev_${group.id}_${row.id}`);
                    const currLossEl = document.getElementById(`currLoss_${group.id}_${row.id}`);

                    if (!isNaN(price) && price > 0) {
                        const comparePrice = index === 0 ? basePrice : prevPrice;
                        const distPrev = comparePrice ? ((price - comparePrice) / comparePrice) * 100 : 0;
                        if (distPrevEl) distPrevEl.textContent = distPrev.toFixed(2) + '%';
                        if (prevPrice && currentRealPos > 0) {
                            currentRealPos = currentRealPos * (price / prevPrice);
                        }
                        prevPrice = price;
                    }

                    if (!isNaN(price) && !isNaN(position) && position > 0) {
                        currentRealPos += position;
                        currentTotalCost += position;

                        const avgPrice = (currentTotalCost / currentRealPos) * price;
                        const currLossU = currentRealPos - currentTotalCost;
                        const currLossPercent = (currLossU / currentTotalCost) * 100;

                        if (cumPosEl) cumPosEl.textContent = currentRealPos.toFixed(2);
                        if (avgPriceEl) avgPriceEl.textContent = avgPrice.toFixed(4);
                        if (currLossEl) currLossEl.textContent = currLossU.toFixed(2) + 'ï¼ˆ' + currLossPercent.toFixed(2) + '%ï¼‰';

                        // ğŸŒŸ ç”¨æˆ·æ–°å¢ï¼šå›æœ¬ %
                        if (recoveryEl) {
                            const recPercent = ((price - avgPrice) / price) * 100;
                            recoveryEl.textContent = recPercent.toFixed(2) + '%';
                        }

                        // å¼ºå¹³ä»·è®¡ç®— (Cross Margin)
                        if (walletBalance > 0 && liqPriceEl && group.includeInMargin !== false) {
                            const othersPnL = (totalRealPosition - currentRealPos) - (totalCost - currentTotalCost);
                            const liqTarget = currentTotalCost - walletBalance - othersPnL;
                            if (liqTarget <= 0) {
                                liqPriceEl.textContent = 'å®‰å…¨';
                                liqPriceEl.style.color = '#28a745';
                            } else {
                                const liqPrice = (liqTarget / currentRealPos) * price;
                                liqPriceEl.textContent = liqPrice.toFixed(priceDecimals);
                                liqPriceEl.style.color = '#dc3545';
                                liqPriceEl.style.fontWeight = 'bold';
                            }
                        } else if (liqPriceEl) {
                            liqPriceEl.textContent = '-';
                        }
                    } else {
                        if (currentRealPos > 0 && !isNaN(price)) {
                            const currLossU = currentRealPos - currentTotalCost;
                            const currLossPercent = (currLossU / currentTotalCost) * 100;
                            if (currLossEl) currLossEl.textContent = currLossU.toFixed(2) + 'ï¼ˆ' + currLossPercent.toFixed(2) + '%ï¼‰';
                            if (cumPosEl) cumPosEl.textContent = currentRealPos.toFixed(2);

                            // ğŸŒŸ ç”¨æˆ·æ–°å¢ï¼šå›æœ¬ % (æœªä¹°å…¥æ­¤è¡Œä½†æœ‰æŒä»“æ—¶)
                            if (recoveryEl) {
                                const currentAvgPrice = (currentTotalCost / currentRealPos) * price;
                                const recPercent = ((price - currentAvgPrice) / price) * 100;
                                recoveryEl.textContent = recPercent.toFixed(2) + '%';
                            }

                            if (walletBalance > 0 && liqPriceEl && group.includeInMargin !== false) {
                                const othersPnL = (totalRealPosition - currentRealPos) - (totalCost - currentTotalCost);
                                const liqTarget = currentTotalCost - walletBalance - othersPnL;
                                if (liqTarget <= 0) {
                                    liqPriceEl.textContent = 'å®‰å…¨';
                                    liqPriceEl.style.color = '#28a745';
                                } else {
                                    const liqPrice = (liqTarget / currentRealPos) * price;
                                    liqPriceEl.textContent = liqPrice.toFixed(priceDecimals);
                                    liqPriceEl.style.color = '#dc3545';
                                    liqPriceEl.style.fontWeight = 'bold';
                                }
                            } else if (liqPriceEl) {
                                liqPriceEl.textContent = '-';
                            }
                        } else {
                            if (currLossEl) currLossEl.textContent = '-';
                            if (cumPosEl) cumPosEl.textContent = '-';
                            if (liqPriceEl) liqPriceEl.textContent = '-';
                            if (recoveryEl) recoveryEl.textContent = '-';
                        }
                        if (avgPriceEl) avgPriceEl.textContent = '-';
                    }
                });
            });
        }

        // localStorage ç¼“å­˜å’Œåç«¯åŒæ­¥
        let syncTimeout = null;
        function saveDCAToStorage() {
            localStorage.setItem('dca_groups', JSON.stringify(dcaGroups));
            localStorage.setItem('dca_groupIdCounter', groupIdCounter);
            localStorage.setItem('dca_globalRowIdCounter', globalRowIdCounter);
            localStorage.setItem('dca_globalWalletBalance', dcaGlobalWalletBalance);

            // è§¦å‘å…¨é‡è‡ªåŠ¨ä¿å­˜åŒæ­¥
            debounceSyncToBackend();
        }

        function debounceSyncToBackend() {
            if (syncTimeout) clearTimeout(syncTimeout);
            updateSyncStatus('æ­£åœ¨è¾“å…¥...');
            syncTimeout = setTimeout(() => {
                syncToBackend();
            }, 1000); // åœæ­¢è¾“å…¥ 1 ç§’ååŒæ­¥
        }

        function updateSyncStatus(text, color = '#6c757d') {
            const el = document.getElementById('dcaSyncStatus');
            if (el) {
                el.textContent = text;
                el.style.color = color;
            }
        }

        async function syncToBackend() {
            if (dcaGroups.length === 0) {
                console.log('æ£€æµ‹åˆ°æ•°æ®ä¸ºç©ºï¼Œè·³è¿‡åŒæ­¥ä»¥åŒæ­¥ä¿æŠ¤æœåŠ¡å™¨æ•°æ®');
                return;
            }
            if (syncTimeout) clearTimeout(syncTimeout);
            updateSyncStatus('ğŸ”„ æ­£åœ¨åŒæ­¥åˆ°æœåŠ¡å™¨...');
            const data = {
                groups: dcaGroups,
                groupIdCounter: groupIdCounter,
                globalRowIdCounter: globalRowIdCounter,
                globalWalletBalance: dcaGlobalWalletBalance
            };
            try {
                const response = await fetch('/dca-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    console.log('DCA é…ç½®å·²å…¨é‡åŒæ­¥åˆ°åç«¯');
                    updateSyncStatus('âœ… å·²åŒæ­¥åˆ°æœåŠ¡å™¨', '#28a745');
                } else {
                    updateSyncStatus('âŒ åŒæ­¥å¤±è´¥', '#dc3545');
                }
            } catch (err) {
                console.error('åŒæ­¥åˆ°åç«¯å¤±è´¥:', err);
                updateSyncStatus('âš ï¸ ç½‘ç»œé”™è¯¯', '#dc3545');
            }
        }

        async function loadDCAFromStorage() {
            // 1. ä¼˜å…ˆå°è¯•ä»åç«¯åŠ è½½
            try {
                const response = await fetch('/dca-settings');
                if (response.ok) {
                    const data = await response.json();
                    if (data) {
                        dcaGroups = data.groups || [];
                        groupIdCounter = data.groupIdCounter || 0;
                        globalRowIdCounter = data.globalRowIdCounter || 0;
                        dcaGlobalWalletBalance = data.globalWalletBalance || '';

                        if (dcaGroups.length > 0) {
                            // åŒæ­¥ UI ä¸Šçš„å…¨å±€è¾“å…¥æ¡†
                            document.getElementById('globalWalletBalance').value = dcaGlobalWalletBalance;
                            renderAllGroups();
                            console.log('å·²ä»åç«¯åŠ è½½ DCA é…ç½®');
                            return;
                        }
                    }
                }
            } catch (err) {
                console.error('ä»åç«¯åŠ è½½å¤±è´¥ï¼Œå°†å°è¯•æœ¬åœ°ç¼“å­˜:', err);
            }

            // 2. å¤‡é€‰æ–¹æ¡ˆï¼šä» localStorage åŠ è½½
            const savedGroups = localStorage.getItem('dca_groups');
            const savedGroupCounter = localStorage.getItem('dca_groupIdCounter');
            const savedRowCounter = localStorage.getItem('dca_globalRowIdCounter');
            const savedGlobalBalance = localStorage.getItem('dca_globalWalletBalance');

            if (savedGroups) {
                dcaGroups = JSON.parse(savedGroups);
            }
            if (savedGroupCounter) {
                groupIdCounter = parseInt(savedGroupCounter);
            }
            if (savedRowCounter) {
                globalRowIdCounter = parseInt(savedRowCounter);
            }
            if (savedGlobalBalance) {
                dcaGlobalWalletBalance = savedGlobalBalance;
                document.getElementById('globalWalletBalance').value = dcaGlobalWalletBalance;
            }

            if (dcaGroups.length === 0) {
                // æ²¡æœ‰ç¼“å­˜æ•°æ®ï¼Œæ·»åŠ é»˜è®¤ 1 ä¸ªç»„
                addDCAGroup();
            } else {
                renderAllGroups();
            }
        }

        // åˆå§‹åŒ–
        loadDCAFromStorage();

        function calculatePercentageChange() {
            const startPrice = parseFloat(document.getElementById('startPrice').value);
            const endPrice = parseFloat(document.getElementById('endPrice').value);
            const resultElement = document.getElementById('percentageChangeResult');

            if (isNaN(startPrice) || isNaN(endPrice) || startPrice === 0) {
                resultElement.textContent = 'è¯·æ£€æŸ¥è¾“å…¥æˆ–èµ·å§‹ä»·ä¸èƒ½ä¸º 0';
                return;
            }

            const change = endPrice - startPrice;
            const percentageChange = (change / startPrice) * 100;

            resultElement.textContent = percentageChange.toFixed(4) + '%';
        }

        function calculateAdjustedPrice() {
            const originalPrice = parseFloat(document.getElementById('originalPrice').value);
            const percentage = parseFloat(document.getElementById('percentage').value);
            const resultElement = document.getElementById('adjustedPriceResult');

            if (isNaN(originalPrice) || isNaN(percentage)) {
                resultElement.textContent = 'è¯·æ£€æŸ¥è¾“å…¥';
                return;
            }

            const factor = 1 + (percentage / 100);

            const adjustedPrice = originalPrice * factor;

            resultElement.textContent = adjustedPrice.toFixed(8);
        }

        function copyResult(spanId) {
            const resultSpan = document.getElementById(spanId);
            let textToCopy = resultSpan.textContent;

            if (!textToCopy || textToCopy.includes('æ£€æŸ¥è¾“å…¥') || textToCopy.includes('Â¥')) {
                textToCopy = textToCopy.replace('Â¥', '').trim();
            }

            if (!textToCopy) return;

            navigator.clipboard.writeText(textToCopy).then(() => {
                showCopyMessage();
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š' + textToCopy);
            });
        }

        function showCopyMessage() {
            const message = document.getElementById('copyMessage');
            message.classList.add('visible');

            setTimeout(() => {
                message.classList.remove('visible');
            }, 2000);
        }

        calculatePercentageChange();
        calculateAdjustedPrice();

    </script>

</body>

</html>